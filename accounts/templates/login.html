{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="csrf-token" content="{{ csrf_token }}">
  <title>E-KOLEK Login</title>
  <link rel="icon" type="image/png" href="{% static 'image/clogo.png' %}">
  <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>
  <link rel="stylesheet" href="{% static 'css/login.css' %}" />

  
</head>

<body>
  <header>
    <div class="container">
      <div class="flex-center">
        <img src="{% static 'image/clogo.png' %}" alt="E-KOLEK Logo" class="header-logo">
        <h1>E-KOLEK</h1>
      </div>
    </div>
  </header>

  <main>
    <h2>Welcome to E-KOLEK</h2>
    <p>Choose a login method to access your dashboard.</p>

    {% if messages %}
      {% for message in messages %}
        <!-- Display all user-relevant messages with proper styling -->
        <div class="{% if message.tags == 'success' %}success-message{% else %}error-message{% endif %}">
          {{ message }}
          {% if "attempts remaining" in message.message %}
            <div style="margin-top: 10px; padding: 10px; background-color: #fff3cd; border: 1px solid #ffeaa7; border-radius: 4px; color: #856404;">
              <strong>⚠️ Security Notice:</strong> Multiple failed login attempts detected. Your account will be temporarily locked after 5 failed attempts for security purposes.
            </div>
          {% endif %}
        </div>
      {% endfor %}
    {% endif %}

    <!-- QR LOGIN SECTIONS -->

    {% if False %}
      <!-- OTP removed -->
    {% else %}
      <div class="tabs">
        <button id="codeTab" class="active" onclick="switchTab('code')">Enter Code</button>
        <button id="qrTab" onclick="switchTab('qr')">Scan QR</button>
      </div>

      <div id="codeLogin" class="active">
        <form method="POST" action="{% url 'code_login' %}">
          {% csrf_token %}
          <div>
            <input type="text" name="user_id" placeholder="Enter User ID" required />
          </div>
          <div style="position:relative;">
            <input type="password" name="password" id="passwordInput" placeholder="Enter Password" required style="padding-right: 2.5rem;" />
            <button type="button" id="togglePassword" style="position:absolute; right:0.5rem; top:50%; transform:translateY(-50%); background:none; border:none; cursor:pointer;">
              <svg id="eyeIcon" xmlns="http://www.w3.org/2000/svg" width="22" height="22" fill="none" stroke="#4b5563" stroke-width="2" viewBox="0 0 24 24">
                <path d="M1 12s4-7 11-7 11 7 11 7-4 7-11 7S1 12 1 12z"/>
                <circle cx="12" cy="12" r="3"/>
              </svg>
            </button>
          </div>
          <div>
            <button type="submit">Login</button>
          </div>
        </form>

        <div style="text-align: center; margin-top: 1rem;">
          <a href="{% url 'forgot_password' %}" style="color: var(--green); text-decoration: none; font-size: 0.875rem; font-weight: 500;">
            Forgot Password?
          </a>
        </div>

        <div class="signup-text">
          Don't have an account?
          <a href="{% url 'register' %}">Sign up here</a>
        </div>
      </div>

      <div id="qrLogin">
        <div id="qr-reader"></div>
        <p>Scan your personal QR code to login instantly.</p>
      </div>
    {% endif %}
  </main>

  <div id="loader"><div class="spinner"></div></div>

  <!-- Pass Django URLs to JavaScript -->
  <script>
    window.DJANGO_URLS = {
      qrLogin: '{% url "web_qr_login" %}',
      userDashboard: '{% url "userdashboard" %}'
    };
    window.CSRF_TOKEN = '{{ csrf_token }}';
  </script>

  <script src="{% static 'js/app_common.js' %}"></script>
  <script src="{% static 'js/login.js' %}?v=2.1"></script>
  
  <script>
    // Additional client-side duplicate message removal
    document.addEventListener('DOMContentLoaded', function() {
      const allMessages = document.querySelectorAll('.error-message, .success-message');
      const seenTexts = new Set();
      
      allMessages.forEach(function(messageDiv) {
        const text = messageDiv.textContent.trim();
        
        if (seenTexts.has(text)) {
          // This is a duplicate, remove it
          messageDiv.remove();
        } else {
          seenTexts.add(text);
        }
      });
    });
  </script>

</body>
</html>
