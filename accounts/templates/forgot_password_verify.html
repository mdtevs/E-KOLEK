{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="csrf-token" content="{{ csrf_token }}">
  <title>E-KOLEK - Verify Code</title>
  <link rel="stylesheet" href="{% static 'css/login.css' %}" />
  <link rel="stylesheet" href="{% static 'css/forgot_password_verify.css' %}" />
</head>

<body>
  <header>
    <div class="container">
      <div class="flex-center">
        <img src="{% static 'image/clogo.png' %}" alt="E-KOLEK Logo" class="header-logo">
        <h1>E-KOLEK</h1>
      </div>
    </div>
  </header>

  <main>
    <h2>Verify Code</h2>
    <p>Enter the verification code sent to your {{ method_display }}</p>

    {% if messages %}
      {% for message in messages %}
        <div class="{% if message.tags == 'error' %}error-message{% else %}success-message{% endif %}">
          {{ message }}
        </div>
      {% endfor %}
    {% endif %}

    <div class="info-box">
      <p>üîê We sent a 6-digit verification code to <strong>{{ masked_contact }}</strong></p>
    </div>

    <form method="POST" action="{% url 'forgot_password_verify' %}" id="otpForm">
      {% csrf_token %}
      
      <div class="otp-input-container">
        <input type="text" class="otp-input" maxlength="1" pattern="[0-9]" inputmode="numeric" id="otp1" />
        <input type="text" class="otp-input" maxlength="1" pattern="[0-9]" inputmode="numeric" id="otp2" />
        <input type="text" class="otp-input" maxlength="1" pattern="[0-9]" inputmode="numeric" id="otp3" />
        <input type="text" class="otp-input" maxlength="1" pattern="[0-9]" inputmode="numeric" id="otp4" />
        <input type="text" class="otp-input" maxlength="1" pattern="[0-9]" inputmode="numeric" id="otp5" />
        <input type="text" class="otp-input" maxlength="1" pattern="[0-9]" inputmode="numeric" id="otp6" />
      </div>

      <input type="hidden" name="otp_code" id="otp_code" />

      <div>
        <button type="submit">Verify Code</button>
      </div>
    </form>

    <div class="resend-link">
      <button id="resendBtn" onclick="resendCode()">Resend Code</button>
      <span id="timerText" class="timer" style="display:none;"></span>
    </div>

    <div class="back-link">
      <a href="{% url 'forgot_password' %}">‚Üê Back</a>
    </div>
  </main>

  <div id="loader"><div class="spinner"></div></div>

  <script>
    // Pass Django URLs to JavaScript
    window.DJANGO_URLS = {
      forgotPasswordResend: '{% url "forgot_password_resend" %}'
    };
  </script>
  <script src="{% static 'js/forgot_password_verify.js' %}"></script>
</body>
</html>

    // Handle OTP input
    otpInputs.forEach((input, index) => {
      input.addEventListener('input', (e) => {
        const value = e.target.value;
        
        // Only allow numbers
        if (value && !/^\d$/.test(value)) {
          e.target.value = '';
          return;
        }

        // Move to next input
        if (value && index < otpInputs.length - 1) {
          otpInputs[index + 1].focus();
        }

        // Update hidden input
        updateOtpCode();
      });

      input.addEventListener('keydown', (e) => {
        // Handle backspace
        if (e.key === 'Backspace' && !input.value && index > 0) {
          otpInputs[index - 1].focus();
        }
      });

      input.addEventListener('paste', (e) => {
        e.preventDefault();
        const pastedData = e.clipboardData.getData('text').replace(/\D/g, '');
        
        // Fill inputs with pasted data
        for (let i = 0; i < pastedData.length && i < otpInputs.length; i++) {
          otpInputs[i].value = pastedData[i];
        }
        
        // Focus last filled input
        const lastIndex = Math.min(pastedData.length, otpInputs.length) - 1;
        otpInputs[lastIndex].focus();
        updateOtpCode();
      });
    });

    function updateOtpCode() {
      const otp = Array.from(otpInputs).map(input => input.value).join('');
      otpCodeInput.value = otp;
    }

    // Resend timer
    let countdown = 60;
    let timerInterval;

    function startTimer() {
      resendBtn.disabled = true;
      resendBtn.style.display = 'none';
      timerText.style.display = 'inline';
      countdown = 60;

      timerInterval = setInterval(() => {
        countdown--;
        timerText.textContent = `Resend code in ${countdown}s`;

        if (countdown <= 0) {
          clearInterval(timerInterval);
          resendBtn.disabled = false;
          resendBtn.style.display = 'inline';
          timerText.style.display = 'none';
        }
      }, 1000);
    }

    // Start timer on page load
    startTimer();

    function resendCode() {
      if (resendBtn.disabled) return;

      const loader = document.getElementById('loader');
      loader.style.display = 'flex';

      fetch('{% url "forgot_password_resend" %}', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/x-www-form-urlencoded',
          'X-CSRFToken': csrfToken
        }
      })
      .then(response => response.json())
      .then(data => {
        loader.style.display = 'none';
        if (data.success) {
          alert('‚úÖ Verification code resent successfully!');
          startTimer();
        } else {
          alert('‚ùå ' + (data.error || 'Failed to resend code'));
        }
      })
      .catch(error => {
        loader.style.display = 'none';
        alert('‚ùå Network error. Please try again.');
        console.error('Error:', error);
      });
    }

    // Form submission
    form.addEventListener('submit', (e) => {
      updateOtpCode();
      if (otpCodeInput.value.length !== 6) {
        e.preventDefault();
        alert('Please enter all 6 digits of the verification code.');
      }
    });
  </script>
</body>
</html>
