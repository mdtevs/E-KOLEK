{% load static %}
<!DOCTYPE html>
<html lang="en" >
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="csrf-token" content="{{ csrf_token }}">
  <title>E-KOLEK - Sign Up</title>
  <link rel="icon" type="image/png" href="{% static 'image/clogo.png' %}">
  <link rel="stylesheet" href="{% static 'css/register.css' %}?v=1.2" />
  
</head>
<body>

  <!-- Header -->
  <header>
    <div class="container">
      <div class="flex-center">
        <img src="{% static 'image/clogo.png' %}" alt="E-KOLEK Logo" class="header-logo">
        <h1>E-KOLEK</h1>
      </div>
    </div>
  </header>

  <!-- Main -->
  <main class="main">
    <div class="form-container">

      <div class="form-header">
        <div class="icon-circle">
          <svg xmlns="http://www.w3.org/2000/svg" class="user-icon" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
            <path d="M16 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/>
            <circle cx="12" cy="7" r="4"/>
            <path d="M20 8v6M23 11h-6"/>
          </svg>
        </div>
        <h2>Register Your Family</h2>
        <p>Create a new family account and become the family representative</p>
      </div>

      <div class="info-box">
        <p><strong>Family Representative Benefits:</strong> As the family representative, you'll be able to manage family members, track collective points, and oversee family activities.</p>
      </div>

      <form method="POST" class="signup-form" novalidate>
        {% csrf_token %}

        <div class="form-group">
          <label for="id_family_name">Family Name</label>
          <input id="id_family_name" name="family_name" type="text" placeholder="Enter your family name" value="{{ form.family_name.value|default:'' }}" required />
          {% if form.family_name.errors %}
            <p class="error-text">{{ form.family_name.errors|striptags }}</p>
          {% endif %}
        </div>

        <div class="form-row">
          <div class="form-group form-group-half">
            <label for="id_first_name">Representative First Name</label>
            <input id="id_first_name" name="first_name" type="text" placeholder="First name" value="{{ form.first_name.value|default:'' }}" required />
            {% if form.first_name.errors %}
              <p class="error-text">{{ form.first_name.errors|striptags }}</p>
            {% endif %}
          </div>
          
          <div class="form-group form-group-half">
            <label for="id_last_name">Representative Last Name</label>
            <input id="id_last_name" name="last_name" type="text" placeholder="Last name" value="{{ form.last_name.value|default:'' }}" required />
            {% if form.last_name.errors %}
              <p class="error-text">{{ form.last_name.errors|striptags }}</p>
            {% endif %}
          </div>
        </div>

        <div class="form-group">
          <label for="id_phone">Representative Phone</label>
          <div style="display: flex; gap: 10px; align-items: flex-start;">
            <div style="flex: 1;">
              <input id="id_phone" name="phone" type="text" placeholder="09123456789" maxlength="11" value="{{ form.phone.value|default:'' }}" required />
              {% if form.phone.errors %}
                <p class="error-text">{{ form.phone.errors|striptags }}</p>
              {% endif %}
            </div>
            <button type="button" id="sendOtpBtn" class="btn-send-otp" style="padding: 12px 20px; background: #6366f1; color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: 600; white-space: nowrap;">
              Send OTP
            </button>
          </div>
        </div>

        <!-- OTP Verification Section (Hidden by default) -->
        <div id="otpVerificationSection" style="display: none;" class="form-group">
          <label for="id_otp_code">Enter OTP Code</label>
          <div style="display: flex; gap: 10px; align-items: flex-start;">
            <div style="flex: 1;">
              <input id="id_otp_code" name="otp_code" type="text" placeholder="Enter 6-digit OTP" maxlength="6" />
              <small class="help-text" id="otpTimer" style="color: #059669;">OTP sent! Valid for 5 minutes</small>
            </div>
            <button type="button" id="verifyOtpBtn" class="btn-verify-otp" style="padding: 12px 20px; background: #059669; color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: 600; white-space: nowrap;">
              Verify OTP
            </button>
          </div>
          <button type="button" id="resendOtpBtn" class="link-login" style="background: none; border: none; color: #6366f1; cursor: pointer; text-decoration: underline; font-size: 0.9rem; margin-top: 8px; padding: 0;">
            Resend OTP
          </button>
          <div id="otpStatusMessage" style="margin-top: 8px;"></div>
        </div>

        <!-- Hidden field to track OTP verification status -->
        <input type="hidden" id="otp_verified" name="otp_verified" value="false" />

        <div class="form-group">
          <label for="id_email">Representative Email</label>
          <div style="display: flex; gap: 10px; align-items: flex-start;">
            <div style="flex: 1;">
              <input id="id_email" name="email" type="email" placeholder="email@example.com" value="{{ form.email.value|default:'' }}" required />
              {% if form.email.errors %}
                <p class="error-text">{{ form.email.errors|striptags }}</p>
              {% endif %}
            </div>
            <button type="button" id="sendEmailOtpBtn" class="btn-send-otp" style="padding: 12px 20px; background: #6366f1; color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: 600; white-space: nowrap;">
              Send OTP
            </button>
          </div>
        </div>

        <!-- Email OTP Verification Section (Hidden by default) -->
        <div id="emailOtpVerificationSection" style="display: none;" class="form-group">
          <label for="id_email_otp_code">Enter Email OTP Code</label>
          <div style="display: flex; gap: 10px; align-items: flex-start;">
            <div style="flex: 1;">
              <input id="id_email_otp_code" name="email_otp_code" type="text" placeholder="Enter 6-digit OTP" maxlength="6" />
              <small class="help-text" id="emailOtpTimer" style="color: #059669;">OTP sent! Valid for 5 minutes</small>
            </div>
            <button type="button" id="verifyEmailOtpBtn" class="btn-verify-otp" style="padding: 12px 20px; background: #059669; color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: 600; white-space: nowrap;">
              Verify OTP
            </button>
          </div>
          <button type="button" id="resendEmailOtpBtn" class="link-login" style="background: none; border: none; color: #6366f1; cursor: pointer; text-decoration: underline; font-size: 0.9rem; margin-top: 8px; padding: 0;">
            Resend OTP
          </button>
          <div id="emailOtpStatusMessage" style="margin-top: 8px;"></div>
        </div>

        <!-- Hidden field to track email OTP verification status -->
        <input type="hidden" id="email_otp_verified" name="email_otp_verified" value="false" />

        <div class="form-group">
          <label for="id_date_of_birth">Date of Birth (Optional)</label>
          <input id="id_date_of_birth" name="date_of_birth" type="date" value="{{ form.date_of_birth.value|default:'' }}" />
          {% if form.date_of_birth.errors %}
            <p class="error-text">{{ form.date_of_birth.errors|striptags }}</p>
          {% endif %}
        </div>

        <div class="form-group">
          <label for="id_gender">Gender (Optional)</label>
          <select id="id_gender" name="gender">
            <option value="" {% if not form.gender.value %}selected{% endif %}>Select Gender</option>
            <option value="male" {% if form.gender.value == 'male' %}selected{% endif %}>Male</option>
            <option value="female" {% if form.gender.value == 'female' %}selected{% endif %}>Female</option>
            <option value="other" {% if form.gender.value == 'other' %}selected{% endif %}>Other</option>
          </select>
          {% if form.gender.errors %}
            <p class="error-text">{{ form.gender.errors|striptags }}</p>
          {% endif %}
        </div>

        <div class="form-group">
          <label for="id_barangay">Barangay</label>
          <select id="id_barangay" name="barangay" required>
            <option value="" disabled {% if not form.barangay.value %}selected{% endif %}>Select your Barangay</option>
            {% for barangay in barangays %}
              <option value="{{ barangay.id }}"
                {% if barangay.id|stringformat:"s" == form.barangay.value|stringformat:"s" %}selected{% endif %}>
                {{ barangay.name }}
              </option>
            {% endfor %}
          </select>
          {% if form.barangay.errors %}
            <p class="error-text">{{ form.barangay.errors|striptags }}</p>
          {% endif %}
        </div>

        <div class="form-group">
          <label for="id_address">Address</label>
          <input id="id_address" name="address" type="text" placeholder="House No. and Street" value="{{ form.address.value|default:'' }}" required />
          {% if form.address.errors %}
            <p class="error-text">{{ form.address.errors|striptags }}</p>
          {% endif %}
        </div>

        <div class="form-group">
          <label for="id_city">City</label>
          <input id="id_city" name="city" type="text" placeholder="Enter your city" value="{{ form.city.value|default:'' }}" required />
          {% if form.city.errors %}
            <p class="error-text">{{ form.city.errors|striptags }}</p>
          {% endif %}
        </div>

        <div class="form-group">
          <label for="id_preferred_user_id">Representative User ID</label>
          <input id="id_preferred_user_id" name="username" type="text" placeholder="Choose a User ID for representative" value="{{ form.username.value|default:'' }}" required />
          {% if form.username.errors %}
            <p class="error-text">{{ form.username.errors|striptags }}</p>
          {% endif %}
        </div>

        <div class="form-group">
          <label for="id_referral_code">Referral Code (Optional)</label>
          <input id="id_referral_code" name="referral_code" type="text" placeholder="Enter referral code for 10 bonus points" value="{{ form.referral_code.value|default:'' }}" maxlength="8" />
          <small class="help-text">Get 10 bonus points by entering a valid referral code</small>
          {% if form.referral_code.errors %}
            <p class="error-text">{{ form.referral_code.errors|striptags }}</p>
          {% endif %}
        </div>

        <div class="form-group">
          <label for="id_password1">Password</label>
          <div class="input-wrapper">
            <input id="id_password1" name="password1" type="password" placeholder="Enter password" required />
            <button type="button" id="togglePassword1" class="eye-btn" tabindex="-1">
              <svg id="eyeIcon1" xmlns="http://www.w3.org/2000/svg" width="22" height="22" fill="none" stroke="#4b5563" stroke-width="2" viewBox="0 0 24 24">
                <path d="M1 12s4-7 11-7 11 7 11 7-4 7-11 7S1 12 1 12z"/>
                <circle cx="12" cy="12" r="3"/>
              </svg>
            </button>
          </div>
          {% if form.password1.errors %}
            <p class="error-text">{{ form.password1.errors|striptags }}</p>
          {% endif %}
        </div>

        <div class="form-group">
          <label for="id_password2">Confirm Password</label>
          <div class="input-wrapper">
            <input id="id_password2" name="password2" type="password" placeholder="Confirm password" required />
            <button type="button" id="togglePassword2" class="eye-btn" tabindex="-1">
              <svg id="eyeIcon2" xmlns="http://www.w3.org/2000/svg" width="22" height="22" fill="none" stroke="#4b5563" stroke-width="2" viewBox="0 0 24 24">
                <path d="M1 12s4-7 11-7 11 7 11 7-4 7-11 7S1 12 1 12z"/>
                <circle cx="12" cy="12" r="3"/>
              </svg>
            </button>
          </div>
          {% if form.password2.errors %}
            <p class="error-text">{{ form.password2.errors|striptags }}</p>
          {% endif %}
        </div>

        <!-- Terms and Conditions Section -->
        <div class="terms-section" style="background: linear-gradient(135deg, #f0f9ff 0%, #e0f2fe 100%); border: 2px solid #0ea5e9; border-radius: 12px; padding: 20px; margin-top: 24px; box-shadow: 0 4px 6px rgba(14, 165, 233, 0.1);">
          <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 16px;">
            <div style="background: #0ea5e9; width: 36px; height: 36px; border-radius: 8px; display: flex; align-items: center; justify-content: center; flex-shrink: 0;">
              <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round">
                <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
                <polyline points="14 2 14 8 20 8"></polyline>
                <line x1="12" y1="18" x2="12" y2="12"></line>
                <line x1="9" y1="15" x2="15" y2="15"></line>
              </svg>
            </div>
            <div>
              <h3 style="margin: 0; font-size: 1.1rem; color: #0c4a6e; font-weight: 700;">Terms & Conditions Agreement</h3>
              <p style="margin: 4px 0 0 0; font-size: 0.85rem; color: #075985;">Required to complete registration</p>
            </div>
          </div>
          
          <div class="custom-checkbox-wrapper" id="termsCheckboxWrapper" style="background: white; border-radius: 10px; padding: 16px; border: 2px solid #bae6fd; transition: all 0.3s ease;">
            <label for="id_accept_terms" class="custom-checkbox-label" style="display: flex; align-items: flex-start; gap: 14px; cursor: pointer; margin: 0;">
              <div class="checkbox-box" style="position: relative; width: 24px; height: 24px; flex-shrink: 0; margin-top: 2px;">
                <input 
                  type="checkbox" 
                  id="id_accept_terms" 
                  name="accept_terms" 
                  required 
                  class="terms-checkbox-input"
                />
                <span class="checkbox-custom"></span>
              </div>
              <span style="flex: 1; font-size: 0.95rem; line-height: 1.6; color: #1e293b; font-weight: 500;">
                I have read and agree to the 
                <button 
                  type="button" 
                  id="viewTermsBtn" 
                  style="background: none; border: none; color: #0ea5e9; cursor: pointer; font-weight: 700; padding: 0; font-size: 0.95rem; text-decoration: none; border-bottom: 2px solid transparent; transition: border-color 0.2s ease;"
                  onmouseover="this.style.borderBottomColor='#0ea5e9'" 
                  onmouseout="this.style.borderBottomColor='transparent'"
                >
                  Terms and Conditions
                </button>
                and understand all policies and guidelines.
              </span>
            </label>
          </div>
          
          {% if form.accept_terms.errors %}
          <div style="margin-top: 12px; padding: 12px; background: #fee2e2; border: 1px solid #fecaca; border-radius: 8px; display: flex; align-items: center; gap: 8px;">
            <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="#dc2626" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <circle cx="12" cy="12" r="10"></circle>
              <line x1="12" y1="8" x2="12" y2="12"></line>
              <line x1="12" y1="16" x2="12.01" y2="16"></line>
            </svg>
            <p class="error-text" style="margin: 0; color: #dc2626; font-size: 0.9rem; font-weight: 600;">{{ form.accept_terms.errors|striptags }}</p>
          </div>
          {% endif %}
        </div>

        <style>
          .custom-checkbox-wrapper:hover {
            box-shadow: 0 4px 12px rgba(14, 165, 233, 0.15);
            transform: translateY(-1px);
          }
          
          .terms-checkbox-input {
            position: absolute;
            opacity: 0;
            width: 0;
            height: 0;
          }
          
          .checkbox-custom {
            position: absolute;
            top: 0;
            left: 0;
            width: 24px;
            height: 24px;
            border: 2.5px solid #94a3b8;
            border-radius: 6px;
            background: white;
            transition: all 0.2s ease;
            cursor: pointer;
          }
          
          .checkbox-custom::after {
            content: '';
            position: absolute;
            display: none;
            left: 7px;
            top: 3px;
            width: 6px;
            height: 11px;
            border: solid white;
            border-width: 0 2.5px 2.5px 0;
            transform: rotate(45deg);
          }
          
          .terms-checkbox-input:checked ~ .checkbox-custom {
            background: #10b981;
            border-color: #10b981;
          }
          
          .terms-checkbox-input:checked ~ .checkbox-custom::after {
            display: block;
          }
          
          .terms-checkbox-input:focus ~ .checkbox-custom {
            box-shadow: 0 0 0 3px rgba(14, 165, 233, 0.2);
          }
        </style>
        
        <script>
          document.addEventListener('DOMContentLoaded', function() {
            const checkbox = document.getElementById('id_accept_terms');
            const wrapper = document.getElementById('termsCheckboxWrapper');
            
            if (checkbox && wrapper) {
              checkbox.addEventListener('change', function() {
                if (this.checked) {
                  wrapper.style.borderColor = '#10b981';
                  wrapper.style.background = '#f0fdf4';
                } else {
                  wrapper.style.borderColor = '#bae6fd';
                  wrapper.style.background = 'white';
                }
              });
            }
          });
        </script>

        <button type="submit" class="btn-submit" id="submitBtn" disabled style="opacity: 0.5; cursor: not-allowed;">Register Family (Verify Phone & Email First)</button>
      </form>



      <p class="text-center text-center-spaced">
        Want to join an existing family? 
        <a href="{% url 'register_member' %}" class="link-login">Join with family code</a>
      </p>
      
      <p class="text-center">
        Already have an account? 
        <a href="{% url 'login_page' %}" class="link-login">Log in here</a>
      </p>

    </div>
  </main>

  <script>
    window.CSRF_TOKEN = '{{ csrf_token }}';
  </script>

  <!-- Terms and Conditions Modal -->
  <div id="termsModal" class="modal-overlay" style="display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); z-index: 9999; justify-content: center; align-items: center;">
    <div class="modal-content" style="background: white; border-radius: 12px; padding: 30px; max-width: 800px; width: 90%; max-height: 80vh; overflow-y: auto; box-shadow: 0 20px 25px -5px rgba(0,0,0,0.1);">
      <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
        <h2 style="margin: 0; color: #1f2937; font-size: 1.5rem;">Terms and Conditions</h2>
        <button type="button" onclick="closeTermsModal()" style="background: none; border: none; font-size: 28px; cursor: pointer; color: #6b7280; line-height: 1;">&times;</button>
      </div>
      
      <div id="termsLoadingMessage" style="text-align: center; padding: 40px; color: #6b7280;">
        <p>Loading Terms and Conditions...</p>
      </div>
      
      <div id="termsContent" style="display: none;">
        <!-- Language Tabs -->
        <div class="terms-tabs" style="display: flex; gap: 8px; margin-bottom: 20px; border-bottom: 2px solid #e5e7eb;">
          <button 
            type="button" 
            id="englishTab" 
            class="terms-tab active" 
            onclick="switchTermsLanguage('english')" 
            style="padding: 12px 24px; background: none; border: none; border-bottom: 3px solid #0ea5e9; color: #0ea5e9; font-weight: 700; cursor: pointer; transition: all 0.2s; font-size: 0.95rem;">
            <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" fill="currentColor" viewBox="0 0 24 24" style="vertical-align: middle; margin-right: 6px;"><circle cx="12" cy="12" r="10" fill="none" stroke="currentColor" stroke-width="2"/><path d="M2 12h20M12 2a15.3 15.3 0 0 1 4 10 15.3 15.3 0 0 1-4 10 15.3 15.3 0 0 1-4-10 15.3 15.3 0 0 1 4-10z"/></svg>
            English
          </button>
          <button 
            type="button" 
            id="tagalogTab" 
            class="terms-tab" 
            onclick="switchTermsLanguage('tagalog')" 
            style="padding: 12px 24px; background: none; border: none; border-bottom: 3px solid transparent; color: #6b7280; font-weight: 600; cursor: pointer; transition: all 0.2s; font-size: 0.95rem;">
            <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" fill="currentColor" viewBox="0 0 24 24" style="vertical-align: middle; margin-right: 6px;"><circle cx="12" cy="12" r="10" fill="none" stroke="currentColor" stroke-width="2"/><path d="M2 12h20M12 2a15.3 15.3 0 0 1 4 10 15.3 15.3 0 0 1-4 10 15.3 15.3 0 0 1-4-10 15.3 15.3 0 0 1 4-10z"/></svg>
            Tagalog
          </button>
        </div>
        
        <!-- English Version -->
        <div id="englishTermsSection" class="terms-language-section" style="display: block;">
          <div style="background: #f9fafb; padding: 24px; border-radius: 12px; border: 2px solid #e5e7eb;">
            <h4 id="englishTermsTitle" style="margin-top: 0; color: #1f2937; font-size: 1.25rem; margin-bottom: 8px;"></h4>
            <p style="font-size: 0.875rem; color: #6b7280; margin-bottom: 20px;">
              <strong>Version:</strong> <span id="englishTermsVersion"></span>
            </p>
            <div id="englishTermsText" style="white-space: pre-wrap; line-height: 1.7; color: #374151; max-height: 400px; overflow-y: auto; padding-right: 10px;"></div>
          </div>
        </div>
        
        <!-- Tagalog Version -->
        <div id="tagalogTermsSection" class="terms-language-section" style="display: none;">
          <div style="background: #f0fdf4; padding: 24px; border-radius: 12px; border: 2px solid #d1fae5;">
            <h4 id="tagalogTermsTitle" style="margin-top: 0; color: #1f2937; font-size: 1.25rem; margin-bottom: 8px;"></h4>
            <p style="font-size: 0.875rem; color: #6b7280; margin-bottom: 20px;">
              <strong>Version:</strong> <span id="tagalogTermsVersion"></span>
            </p>
            <div id="tagalogTermsText" style="white-space: pre-wrap; line-height: 1.7; color: #374151; max-height: 400px; overflow-y: auto; padding-right: 10px;"></div>
          </div>
        </div>
      </div>
      
      <script>
        function switchTermsLanguage(language) {
          // Hide all sections
          document.querySelectorAll('.terms-language-section').forEach(section => {
            section.style.display = 'none';
          });
          
          // Remove active class from all tabs
          document.querySelectorAll('.terms-tab').forEach(tab => {
            tab.style.borderBottomColor = 'transparent';
            tab.style.color = '#6b7280';
          });
          
          // Show selected section and activate tab
          if (language === 'english') {
            document.getElementById('englishTermsSection').style.display = 'block';
            document.getElementById('englishTab').style.borderBottomColor = '#0ea5e9';
            document.getElementById('englishTab').style.color = '#0ea5e9';
          } else {
            document.getElementById('tagalogTermsSection').style.display = 'block';
            document.getElementById('tagalogTab').style.borderBottomColor = '#10b981';
            document.getElementById('tagalogTab').style.color = '#10b981';
          }
        }
        
        // Add hover effects
        document.addEventListener('DOMContentLoaded', function() {
          document.querySelectorAll('.terms-tab').forEach(tab => {
            tab.addEventListener('mouseover', function() {
              if (!this.classList.contains('active')) {
                this.style.backgroundColor = '#f9fafb';
              }
            });
            tab.addEventListener('mouseout', function() {
              this.style.backgroundColor = 'transparent';
            });
          });
        });
      </script>
      
      <div id="termsErrorMessage" style="display: none; text-align: center; padding: 40px; color: #ef4444;">
        <p>Unable to load Terms and Conditions. Please try again later.</p>
      </div>
      
      <div style="margin-top: 25px; text-align: right;">
        <button type="button" onclick="closeTermsModal()" style="background: #6366f1; color: white; padding: 10px 24px; border: none; border-radius: 6px; cursor: pointer; font-weight: 600;">Close</button>
      </div>
    </div>
  </div>

  <script src="{% static 'js/app_common.js' %}"></script>
  <script src="{% static 'js/register.js' %}?v=9.0"></script>
  <script src="{% static 'js/email_verification.js' %}?v=2.0"></script>
  <script src="{% static 'js/terms_modal.js' %}?v=3.0"></script>
  
</body>
</html>
