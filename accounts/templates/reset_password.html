{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="csrf-token" content="{{ csrf_token }}">
  <title>E-KOLEK - Reset Password</title>
  <link rel="icon" type="image/png" href="{% static 'image/clogo.png' %}">
  <link rel="stylesheet" href="{% static 'css/login.css' %}" />
  <link rel="stylesheet" href="{% static 'css/reset_password.css' %}" />
</head>

<body>
  <header>
    <div class="container">
      <div class="flex-center">
        <img src="{% static 'image/logo.png' %}" alt="E-KOLEK Logo" class="header-logo">
        <h1>E-KOLEK</h1>
      </div>
    </div>
  </header>

  <main>
    <h2>Reset Password</h2>
    <p>Create a new strong password for your account</p>

    {% if messages %}
      {% for message in messages %}
        <div class="{% if message.tags == 'error' %}error-message{% else %}success-message{% endif %}">
          {{ message }}
        </div>
      {% endfor %}
    {% endif %}

    <form method="POST" action="{% url 'reset_password' %}" id="resetForm">
      {% csrf_token %}
      
      <div class="password-field">
        <input 
          type="password" 
          name="new_password" 
          id="newPassword"
          placeholder="New Password" 
          required 
          style="padding-right: 2.5rem;"
        />
        <button type="button" class="toggle-password" onclick="togglePassword('newPassword', 'eyeIcon1')">
          <svg id="eyeIcon1" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
            <path d="M1 12s4-7 11-7 11 7 11 7-4 7-11 7S1 12 1 12z"/>
            <circle cx="12" cy="12" r="3"/>
          </svg>
        </button>
      </div>

      <div class="password-field">
        <input 
          type="password" 
          name="confirm_password" 
          id="confirmPassword"
          placeholder="Confirm Password" 
          required 
          style="padding-right: 2.5rem;"
        />
        <button type="button" class="toggle-password" onclick="togglePassword('confirmPassword', 'eyeIcon2')">
          <svg id="eyeIcon2" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
            <path d="M1 12s4-7 11-7 11 7 11 7-4 7-11 7S1 12 1 12z"/>
            <circle cx="12" cy="12" r="3"/>
          </svg>
        </button>
      </div>

      <div class="password-requirements">
        <h4>Password Requirements:</h4>
        <ul id="requirements">
          <li id="req-length">At least 8 characters</li>
          <li id="req-uppercase">At least one uppercase letter</li>
          <li id="req-lowercase">At least one lowercase letter</li>
          <li id="req-number">At least one number</li>
          <li id="req-match">Passwords must match</li>
        </ul>
      </div>

      <div>
        <button type="submit" id="submitBtn">Reset Password</button>
      </div>
    </form>
  </main>

  <div id="loader"><div class="spinner"></div></div>

  <script>
    const newPasswordInput = document.getElementById('newPassword');
    const confirmPasswordInput = document.getElementById('confirmPassword');
    const submitBtn = document.getElementById('submitBtn');
    const form = document.getElementById('resetForm');

    // Password validation
    const requirements = {
      length: { element: document.getElementById('req-length'), test: (pw) => pw.length >= 8 },
      uppercase: { element: document.getElementById('req-uppercase'), test: (pw) => /[A-Z]/.test(pw) },
      lowercase: { element: document.getElementById('req-lowercase'), test: (pw) => /[a-z]/.test(pw) },
      number: { element: document.getElementById('req-number'), test: (pw) => /\d/.test(pw) },
      match: { element: document.getElementById('req-match'), test: () => newPasswordInput.value === confirmPasswordInput.value && newPasswordInput.value.length > 0 }
    };

    function validatePassword() {
      const password = newPasswordInput.value;
      let allValid = true;

      // Check each requirement
      Object.keys(requirements).forEach(key => {
        const req = requirements[key];
        const isValid = req.test(password);
        
        if (isValid) {
          req.element.classList.remove('invalid');
          req.element.classList.add('valid');
        } else {
          req.element.classList.remove('valid');
          req.element.classList.add('invalid');
          allValid = false;
        }
      });

      // Enable/disable submit button
      submitBtn.disabled = !allValid;
      submitBtn.style.opacity = allValid ? '1' : '0.6';
      submitBtn.style.cursor = allValid ? 'pointer' : 'not-allowed';

      return allValid;
    }

    // Validate on input
    newPasswordInput.addEventListener('input', validatePassword);
    confirmPasswordInput.addEventListener('input', validatePassword);

    // Toggle password visibility
    function togglePassword(inputId, iconId) {
      const input = document.getElementById(inputId);
      const icon = document.getElementById(iconId);
      
      if (input.type === 'password') {
        input.type = 'text';
        icon.innerHTML = '<path d="M1 1l22 22"/><path d="M9.88 9.88a3 3 0 1 0 4.24 4.24"/><path d="M10.73 5.08A10.43 10.43 0 0 1 12 5c7 0 11 7 11 7a13.16 13.16 0 0 1-1.67 2.68"/><path d="M6.61 6.61A13.526 13.526 0 0 0 1 12s4 7 11 7a9.74 9.74 0 0 0 5.39-1.61"/>';
      } else {
        input.type = 'password';
        icon.innerHTML = '<path d="M1 12s4-7 11-7 11 7 11 7-4 7-11 7S1 12 1 12z"/><circle cx="12" cy="12" r="3"/>';
      }
    }

    // Form submission
    form.addEventListener('submit', (e) => {
      if (!validatePassword()) {
        e.preventDefault();
        alert('Please ensure all password requirements are met.');
      }
    });

    // Initial validation
    validatePassword();
  </script>
</body>
</html>