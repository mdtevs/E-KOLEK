{% load static %}
{% load points_filters %}


<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="csrf-token" content="{{ csrf_token }}">
    <!-- Boxicons from multiple CDNs for reliability -->
    <link href='https://unpkg.com/boxicons@2.1.4/css/boxicons.min.css' rel='stylesheet'>
    <link href='https://cdn.jsdelivr.net/npm/boxicons@2.1.4/css/boxicons.min.css' rel='stylesheet'>
    <link rel="stylesheet" href="{% static 'style.css' %}">
    <link rel="stylesheet" href="{% static 'css/adminpoints.css' %}?v={{ timestamp }}">
    <script src="https://unpkg.com/html5-qrcode"></script>
    <title>AdminPanel</title>
    
</head>
<body>


	<!-- SIDEBAR -->
	<section id="sidebar">
		<a href="#" class="brand">
			<i class='bx bxs-group' ></i>
			<span class="text">CENRO Admin</span>
		</a>
				<ul class="side-menu top">
			<!-- Dashboard/Home -->
			<li>
				<a href="{% url 'cenro:dashboard' %}">
					<i class='bx bxs-dashboard'></i>
					<span class="text">Dashboard</span>
				</a>
			</li>

			{% if can_manage_users %}
			<li>
				<a href="{% url 'cenro:adminuser' %}">
					<i class='bx bxs-user-detail'></i>
					<span class="text">User Management</span>
				</a>
			</li>
			{% endif %}

			{% if admin_user.role == 'super_admin' %}
			<li>
				<a href="{% url 'cenro:admin_management' %}">
					<i class='bx bxs-user-detail' ></i>
					<span class="text">Admin Management</span>
				</a>
			</li>
			{% endif %}
			
			{% if can_manage_controls %}
			<li>
				<a href="{% url 'cenro:admincontrol' %}">
					<i class='bx bxs-component' ></i>
					<span class="text">Controls Management</span>
				</a>
			</li>
			{% endif %}
			
			{% if can_manage_points %}
			<li class="active">
				<a href="{% url 'cenro:adminpoints' %}">
					<i class='bx bxs-star' ></i>
					<span class="text">Points Management</span>
				</a>
			</li>
			{% endif %}
			
			{% if can_manage_rewards %}
			<li>
				<a href="{% url 'cenro:adminrewards' %}">
					<i class='bx bxs-gift' ></i>
					<span class="text">Rewards Management</span>
				</a>
			</li>
			{% endif %}

			{% if can_manage_schedules %}
			<li>
				<a href="{% url 'cenro:adminschedule' %}">
					<i class='bx bxs-calendar' ></i>
					<span class="text">Schedule Management</span>
				</a>
			</li>
			{% endif %}

			{% if can_manage_security %}
			<li>
<a href="{% url 'cenro:security_dashboard' %}">
<i class='bx bxs-shield' ></i>
<span class="text">Security Management</span>
</a>
</li>
			{% endif %}

			{% if can_manage_learning %}
			<li>
				<a href="{% url 'cenro:adminlearn' %}">
					<i class='bx bxs-book-content' ></i>
					<span class="text">Learning Management</span>
				</a>
			</li>
			{% endif %}

			{% if can_manage_games %}
			<li>
				<a href="{% url 'cenro:admingames' %}">
					<i class='bx bxs-game' ></i>
					<span class="text">Games Management</span>
				</a>      
      <li>
        <a href="{% url 'cenro:waste_analytics' %}">
          <i class='bx bxs-bar-chart-alt-2' ></i>
          <span class="text">Waste Analytics</span>
        </a>
      </li>
      
			</li>
			{% endif %}
			
			<!-- Security Analyst Special Dashboard -->
			{% if admin_role == 'security_analyst' %}
			<li>
				<a href="{% url 'cenro:adminsecurity' %}">
					<i class='bx bxs-dashboard' ></i>
					<span class="text">Security Dashboard</span>
				</a>
			</li>
			{% endif %}
			
		</ul>
		<ul class="side-menu">
			<li>
				<a href="{% url 'cenro:admin_logout' %}" class="logout">
					<i class='bx bxs-log-out-circle' ></i>
					<span class="text">Logout</span>
				</a>
			</li>
		</ul>
	</section>
	<!-- SIDEBAR -->



	<!-- CONTENT -->
	<section id="content">
		<!-- NAVBAR -->
				<nav>
			<i class='bx bx-menu' ></i>
			
			<!-- Admin User Profile Section -->
			{% if is_admin_authenticated %}
			<div class="profile" style="margin-left: auto; display: flex; align-items: center; gap: 10px;">
				<!-- Admin Notification Bell -->
				{% include 'includes/notification_bell.html' %}
				
				<div class="admin-info" style="text-align: right; margin-right: 10px;">
					<span style="display: block; font-weight: 600; color: #333;">{{ admin_full_name }}</span>
					<span style="display: block; font-size: 0.8rem; color: #666;">{{ admin_role_display }}</span>
				</div>
				<i class='bx bxs-user-circle' style="font-size: 2rem; color: #667eea;"></i>
			</div>
			{% else %}
			<div class="profile" style="margin-left: auto;">
				<a href="{% url 'cenro:admin_login' %}" style="color: #667eea; text-decoration: none;">
					<i class='bx bx-log-in' style="font-size: 1.5rem;"></i>
					<span>Login</span>
				</a>
			</div>
			{% endif %}
		</nav>
		<!-- NAVBAR -->

		<!-- MAIN -->
		<main>
  <div class="head-title">
    <div class="left">
      <h1>Points&Rewards Management</h1>
      <ul class="breadcrumb">
        <li><a href="#">Points&Rewards</a></li>
        <li><i class='bx bx-chevron-right'></i></li>
        <li><a class="active" href="#">Home</a></li>
      </ul>
    </div>
  </div>


  <!-- QR Scanner & Waste Transaction Modal -->
  <div class="card" style="max-width:500px;margin:auto;margin-top:3rem;">
    <h3 class="card-title">Waste Collection QR Scanner</h3>
    <!-- Scanner Box -->
    <div id="scanner-box" class="scanner-box"></div>
    <button class="btn-start-scanner" onclick="startQrScanner()">Start Scanner</button>
  </div>

  <div class="card" style="max-width:600px;margin:2rem auto;">
  <!-- TAB HEADERS -->
  <div class="tab-header" style="display:flex;justify-content:space-around;margin-bottom:1rem;">
    <button class="tab-btn active" onclick="openTab(event, 'wasteTab')">Waste Transaction</button>
    <button class="tab-btn" onclick="openTab(event, 'redeemTab')">Redeem Rewards</button>
  </div>

  <!-- TAB CONTENT: WASTE TRANSACTION -->
  <div id="wasteTab" class="tab-content" style="display:block;">
    <h3 class="card-title">Waste Transaction</h3>
    <form id="wasteForm" class="manual-form">
      {% csrf_token %}
      <label>Name</label>
      <input type="text" id="userName" name="user_name" readonly>
      <label>Family Code</label>
      <input type="text" id="familyCode" name="family_code" readonly>
      <input type="hidden" id="userId" name="user_id">
      <label>Waste Type</label>
      <select id="wasteType" name="waste_type" required>
        <option disabled selected>Select Waste Type</option>
        {% for waste in waste_types %}
        <option value="{{ waste.id }}" data-points="{{ waste.points_per_kg }}">{{ waste.name }}</option>
        {% endfor %}
      </select>
      <label>Waste KG</label>
      <input type="number" id="wasteKg" name="waste_kg" min="0.01" step="0.01" required>
      <label>Total Points</label>
      <input type="number" id="totalPoints" name="total_points" readonly>
      <button type="submit" class="btn-process" style="margin-top:1rem;">Save Transaction</button>
    </form>
  </div>

  <!-- TAB CONTENT: REDEEM REWARDS -->
  <div id="redeemTab" class="tab-content" style="display:none;">
    <h3 class="card-title">Redeem Rewards</h3>
    <form id="redeemForm" class="manual-form">
      {% csrf_token %}
      <label>Name</label>
      <input type="text" id="redeemUserName" name="user_name" readonly>
      <label>Family Code</label>
      <input type="text" id="redeemFamilyCode" name="family_code" readonly>
      <input type="hidden" id="redeemUserId" name="user_id">
      <label>Select Reward</label>
      <select id="rewardSelect" name="reward_id" required>
        <option disabled selected>Select Reward</option>
        {% for reward in rewards %}
        <option value="{{ reward.id }}" data-points="{{ reward.points_required }}">
          {{ reward.name }} ({{ reward.points_required }} pts)
        </option>
        {% endfor %}
      </select>
      <label>Points Required</label>
      <input type="number" id="requiredPoints" name="points_required" readonly>
      <button type="submit" class="btn-process" style="margin-top:1rem;">Redeem</button>
    </form>
  </div>
</div>

</main>

		
	</section>
	
	

	<script src="{% static 'script.js' %}"></script>
	
	<!-- Pass Django URLs and data to JavaScript -->
	<script>
		window.DJANGO_URLS = {
			getUserById: '/api/get-user-by-id/',
			saveWasteTransaction: '/api/save-waste-transaction/',
			redeemReward: '/api/redeem-reward/'
		};
		window.CSRF_TOKEN = '{{ csrf_token }}';
	</script>
	
  <script src="{% static 'js/admin_common.js' %}?v={{ timestamp }}"></script>
  <script src="{% static 'js/tab-persistence.js' %}?v={{ timestamp }}"></script>
  <script src="{% static 'js/adminpoints.js' %}?v={{ timestamp }}"></script>
	<script src="{% static 'js/admin_notifications.js' %}"></script>
</body>
</html>
